<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì£¼ì—­(íŒ”ê´˜/ìœ¡íš¨) ê¸°ë°˜ ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸° (ë°ëª¨)</title>
  <style>
    * { box-sizing: border-box; }
    :root { 
      color-scheme: light dark;
      --primary: #6366f1;
      --secondary: #ec4899;
      --success: #10b981;
      --danger: #ef4444;
    }
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      color: #1f2937;
    }
    .wrap { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 40px 24px;
    }
    h1 { 
      font-size: 32px; 
      font-weight: 700;
      margin: 0 0 8px;
      background: linear-gradient(120deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    p { 
      line-height: 1.6;
      margin: 0 0 20px;
    }
    .grid { 
      display: grid; 
      gap: 24px; 
      grid-template-columns: 1fr; 
    }
    @media (min-width: 1000px) { 
      .grid { 
        grid-template-columns: 420px 1fr; 
      } 
    }
    .card {
      border: none;
      border-radius: 20px;
      padding: 28px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
    }
    label { 
      display: block; 
      font-size: 13px; 
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      font-size: 15px;
      transition: all 0.2s ease;
      color: #1f2937;
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 14px; 
    }
    @media (min-width: 520px) { 
      .row { 
        grid-template-columns: 1fr 1fr; 
      } 
    }
    button {
      width: 100%;
      margin-top: 16px;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
      letter-spacing: 0.5px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    }
    button:active { 
      transform: translateY(0px);
    }
    .muted { 
      font-size: 13px;
      color: #4b5563;
    }
    .err { 
      color: #dc2626; 
      font-size: 13px; 
      margin-top: 10px;
      font-weight: 500;
    }
    .ok { 
      font-size: 13px; 
      margin-top: 10px;
      color: #059669;
      font-weight: 500;
    }
    .pill {
      display: inline-flex; 
      align-items: center; 
      gap: 8px;
      padding: 10px 14px; 
      border-radius: 20px;
      border: none;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      font-size: 12px;
      font-weight: 600;
      color: #4f46e5;
      margin-bottom: 8px;
    }
    .nums { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 14px; 
      margin: 14px 0 12px;
      min-height: 60px;
    }
    .ball {
      width: 56px; 
      height: 56px; 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      border: none;
      font-weight: 800;
      font-size: 18px;
      color: white;
      user-select: none;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: default;
    }
    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .ball.small { 
      width: 44px; 
      height: 44px;
      font-size: 15px;
    }
    /* ë¡œë˜ ê³µ ìƒ‰ìƒ */
    .ball[data-range="1"] { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .ball[data-range="2"] { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .ball[data-range="3"] { background: linear-gradient(135deg, #f87171, #ef4444); }
    .ball[data-range="4"] { background: linear-gradient(135deg, #9ca3af, #6b7280); }
    .ball[data-range="5"] { background: linear-gradient(135deg, #4ade80, #22c55e); }
    .sectionTitle { 
      margin: 0 0 12px; 
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }
    .hr { 
      height: 1px; 
      background: linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.1), rgba(0,0,0,0.05));
      margin: 20px 0; 
    }
    .hexWrap { 
      display: grid; 
      gap: 16px; 
      grid-template-columns: 1fr; 
    }
    @media (min-width: 560px) { 
      .hexWrap { 
        grid-template-columns: 1fr 1fr; 
      } 
    }

    /* Hexagram lines */
    .hex { 
      padding: 16px; 
      border-radius: 16px; 
      border: 1px solid rgba(99, 102, 241, 0.2);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
    }
    .lineRow { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin: 8px 0; 
      padding: 6px 0;
    }
    .lineLabel { 
      font-size: 12px; 
      font-weight: 600;
      color: #374151;
      white-space: nowrap; 
    }
    .lineBar { 
      flex: 1; 
      display: flex; 
      gap: 8px; 
      justify-content: flex-end; 
    }
    .seg { 
      height: 12px; 
      border-radius: 999px; 
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .yang .seg { 
      width: 100%; 
    }
    .yin .seg { 
      width: calc(50% - 4px); 
    }
    .yin .seg:last-child { 
      margin-left: 8px; 
    }
    .movingTag {
      font-size: 11px; 
      padding: 4px 10px; 
      border-radius: 999px;
      border: 1px solid #ec4899;
      color: #ec4899;
      opacity: 0.9;
      font-weight: 600;
      background: rgba(236, 72, 153, 0.05);
    }
    ul { 
      margin: 12px 0 0 0;
      padding: 0;
      list-style: none;
    }
    ul li {
      margin-bottom: 20px;
      line-height: 1.8;
      color: #1f2937;
      padding: 14px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
      border-left: 4px solid #6366f1;
      border-radius: 8px;
    }
    code.inline { 
      font-family: 'Courier New', monospace; 
      font-size: 12px;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      color: #6366f1;
    }
    select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: #374151;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    option {
      color: #1f2937;
      background: white;
      padding: 8px 12px;
    }
    option:hover {
      background: linear-gradient(#6366f1, #6366f1);
      background-color: #6366f1 !important;
      color: white;
    }
    .date-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .date-input-group select {
      margin: 0;
    }
    .date-input-group small {
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }
    .quick-input {
      margin-top: 12px;
    }
    .quick-input input {
      margin-bottom: 6px;
    }
    #resultEmpty, #result {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì£¼ì—­(íŒ”ê´˜/ìœ¡íš¨) ê¸°ë°˜ ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸° (ë°ëª¨)</h1>
    <p class="muted">
      ì˜¤ë½/ì»¨ì…‰ìš© ì˜ˆì‹œì…ë‹ˆë‹¤. ê°™ì€ ì…ë ¥ê°’ì´ë©´ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë„ë¡ â€œê²°ì •ë¡ ì â€ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
      ë‹¹ì²¨ í™•ë¥ ì„ ë†’ì¸ë‹¤ëŠ” ì˜ë¯¸ê°€ ì•„ë‹™ë‹ˆë‹¤.
    </p>

    <div class="grid">
      <div class="card">
        <label>ìƒë…„ì›”ì¼</label>
        <div class="date-input-group">
          <div>
            <select id="birthYear" required>
              <option value="">ë…„ë„</option>
            </select>
            <small>ë…„</small>
          </div>
          <div>
            <select id="birthMonth" required>
              <option value="">ì›”</option>
            </select>
            <small>ì›”</small>
          </div>
          <div>
            <select id="birthDay" required>
              <option value="">ì¼</option>
            </select>
            <small>ì¼</small>
          </div>
        </div>
        <div class="quick-input">
          <input id="quickDateInput" type="text" placeholder="ë¹ ë¥¸ ì…ë ¥: YYYYMMDD (ì˜ˆ: 19950315)" />
        </div>

        <div style="margin-top: 16px;">
          <label for="birthTime">ìƒì‹œ(ì„ íƒ)</label>
          <div class="row">
            <select id="birthHour">
              <option value="">ì‹œê°„</option>
            </select>
            <select id="birthMinute">
              <option value="">ë¶„</option>
            </select>
          </div>
        </div>

        <button id="btn">ì£¼ì—­ + ë²ˆí˜¸ ìƒì„±</button>
        <div id="msg" class="muted ok"></div>
        <div id="err" class="err"></div>

        <div class="hr"></div>
        <div class="muted">
          <div>ê³µìœ /ì¬í˜„:</div>
          <div>ìƒì„± ì‹œ URLì— <code class="inline">?d=YYYY-MM-DD&t=HH:MM</code> í˜•íƒœë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
          <div>ë¸Œë¼ìš°ì €ê°€ Web Crypto(<code class="inline">crypto.subtle</code>)ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ ê°„ë‹¨ í•´ì‹œ(FNV-1a)ë¡œ í´ë°±í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="card">
        <div class="sectionTitle">ê²°ê³¼</div>
        <div id="resultEmpty" class="muted">ì™¼ìª½ì—ì„œ ìƒë…„ì›”ì¼(í•„ìˆ˜)ê³¼ ìƒì‹œ(ì„ íƒ)ì„ ì…ë ¥í•˜ì„¸ìš”.</div>

        <div id="result" style="display:none;">
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
            <span class="pill" id="pillSeed"></span>
            <span class="pill" id="pillUpper"></span>
            <span class="pill" id="pillLower"></span>
            <span class="pill" id="pillDominant"></span>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle">ë¡œë˜ ë²ˆí˜¸ (5ì„¸íŠ¸)</div>
          <div id="allLottoSets" style="display: grid; gap: 14px;"></div>

          <div class="hr"></div>

          <div class="hexWrap">
            <div class="hex">
              <div class="sectionTitle">ë³¸ê´˜ â€” ì§€ê¸ˆì˜ ì—ë„ˆì§€</div>
              <div style="font-size: 13px; color: #4b5563; margin-bottom: 12px; line-height: 1.5;">
                ë‹¹ì‹ ì˜ ìƒë…„ì›”ì¼ì´ ë‹´ì€ <strong>í˜„ì¬ì˜ íë¦„ê³¼ ìƒí™©</strong>. 
                ì´ ê´˜ëŠ” ì§€ê¸ˆ ë‹¹ì‹ ì´ ì„œ ìˆëŠ” ìë¦¬, ê°€ì§„ ì—ë„ˆì§€, 
                ê·¸ë¦¬ê³  ì´ ìˆœê°„ì˜ í•µì‹¬ ì„±ì§ˆì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
              </div>
              <div id="hexOriginal"></div>
            </div>
            <div class="hex">
              <div class="sectionTitle">ë³€í™” ê´˜ â€” ê°€ëŠ¥ì„±ì˜ ë°©í–¥</div>
              <div style="font-size: 13px; color: #4b5563; margin-bottom: 12px; line-height: 1.5;">
                ë³€íš¨(ë³€í•˜ëŠ” ì„ )ê°€ ë°˜ì „ë˜ì–´ ë‚˜íƒ€ë‚˜ëŠ” <strong>ë³€í™” í›„ì˜ ëª¨ìŠµ</strong>. 
                ë³¸ê´˜ì˜ ì—ë„ˆì§€ê°€ í˜ëŸ¬ê°€ë©° ë¬´ì—‡ìœ¼ë¡œ ë³€ì„±í•  ìˆ˜ ìˆëŠ”ì§€, 
                ë‹¹ì‹ ì˜ ì—ë„ˆì§€ê°€ ë‚˜ì•„ê°ˆ ìˆ˜ ìˆëŠ” ë°©í–¥ì„±ì„ ì œì‹œí•©ë‹ˆë‹¤.
              </div>
              <div id="hexChanged"></div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle">ë‹¹ì‹ ì˜ ìˆ«ìë“¤ â€” ê·¸ë¦¬ê³  ê·¸ ì˜ë¯¸</div>
          <div class="muted">
            ì•„ë˜ì˜ ê° ë¡œë˜ ë²ˆí˜¸ëŠ” ë‹¹ì‹ ì˜ ìƒë…„ì›”ì¼ì´ ë‹´ì€ ì£¼ì—­ì˜ ì—ë„ˆì§€ë¥¼ í’€ì–´ë‚¸ ê²ƒì…ë‹ˆë‹¤.
            <br><br>
            <strong>ë‹¹ì‹ ì˜ ë³¸ê´˜(ì§€ê¸ˆì˜ ìƒíƒœ)ì™€ ë³€í™” ê´˜(í–¥í•˜ëŠ” ë°©í–¥)ëŠ” 5ê°œ ìˆ«ìë¡œ í‘œí˜„ë©ë‹ˆë‹¤.</strong>
            <br>ê° ìˆ«ìëŠ” ë‹¹ì‹ ì˜ ì—ë„ˆì§€ ì§€ë„ ìœ„ì—ì„œ íŠ¹ë³„í•œ ìë¦¬ë¥¼ ì°¨ì§€í•˜ê³  ìˆìœ¼ë©°,
            ê·¸ê²ƒì´ ì–´ë–¤ ì„±ì§ˆì¸ì§€, ì•ˆì •ì ì¸ì§€ ë³€í™” ì¤‘ì¸ì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
          </div>
          <ul id="reasons"></ul>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== íŒ”ê´˜(Trigram) ì •ì˜ =====
    // bit pattern is bottom->top (3 bits): 111=ä¹¾, 000=å¤ ...
    const TRIGRAMS = {
      "111": { key:"qian",  name:"ê±´(ä¹¾)", symbol:"â˜°", nature:"í•˜ëŠ˜", element:"ê¸ˆ(é‡‘)" },
      "110": { key:"dui",   name:"íƒœ(å…Œ)", symbol:"â˜±", nature:"íƒ(ëª»/í˜¸ìˆ˜)", element:"ê¸ˆ(é‡‘)" },
      "101": { key:"li",    name:"ë¦¬(é›¢)", symbol:"â˜²", nature:"ë¶ˆ", element:"í™”(ç«)" },
      "100": { key:"zhen",  name:"ì§„(éœ‡)", symbol:"â˜³", nature:"ì²œë‘¥", element:"ëª©(æœ¨)" },
      "011": { key:"xun",   name:"ì†(å·½)", symbol:"â˜´", nature:"ë°”ëŒ", element:"ëª©(æœ¨)" },
      "010": { key:"kan",   name:"ê°(å)", symbol:"â˜µ", nature:"ë¬¼", element:"ìˆ˜(æ°´)" },
      "001": { key:"gen",   name:"ê°„(è‰®)", symbol:"â˜¶", nature:"ì‚°", element:"í† (åœŸ)" },
      "000": { key:"kun",   name:"ê³¤(å¤)", symbol:"â˜·", nature:"ë•…", element:"í† (åœŸ)" },
    };

    // ìˆ«ìë¥¼ ì˜¤í–‰ì— ë§¤í•‘(ì„ì˜ ê·œì¹™, ì„¤ëª… ìƒì„±ìš©)
    // 1:ëª© 2:í™” 3:í†  4:ê¸ˆ 0:ìˆ˜
    function numberElement(n){
      const r = n % 5;
      if (r === 1) return "ëª©(æœ¨)";
      if (r === 2) return "í™”(ç«)";
      if (r === 3) return "í† (åœŸ)";
      if (r === 4) return "ê¸ˆ(é‡‘)";
      return "ìˆ˜(æ°´)";
    }

    // ìƒìƒ/ìƒê·¹ ê´€ê³„(ê°„ë‹¨ í‘œê¸°)
    const GENERATES = { "ëª©(æœ¨)":"í™”(ç«)", "í™”(ç«)":"í† (åœŸ)", "í† (åœŸ)":"ê¸ˆ(é‡‘)", "ê¸ˆ(é‡‘)":"ìˆ˜(æ°´)", "ìˆ˜(æ°´)":"ëª©(æœ¨)" };
    const OVERCOMES = { "ëª©(æœ¨)":"í† (åœŸ)", "í† (åœŸ)":"ìˆ˜(æ°´)", "ìˆ˜(æ°´)":"í™”(ç«)", "í™”(ç«)":"ê¸ˆ(é‡‘)", "ê¸ˆ(é‡‘)":"ëª©(æœ¨)" };

    // ===== í•´ì‹œ ìœ í‹¸ =====
    async function sha256Bytes(str){
      if (crypto?.subtle?.digest) {
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return new Uint8Array(buf);
      }
      // í´ë°±: FNV-1a 32-bitë¥¼ ë°˜ë³µí•´ì„œ ì˜ì‚¬ë°”ì´íŠ¸ ìƒì„±
      const bytes = new Uint8Array(32);
      let h = 0x811c9dc5;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193) >>> 0;
      }
      for (let i=0;i<32;i++){
        h ^= (i + 0x9e3779b9) >>> 0;
        h = Math.imul(h, 0x01000193) >>> 0;
        bytes[i] = (h >>> ((i % 4) * 8)) & 0xff;
      }
      return bytes;
    }

    // ===== ì£¼ì—­(6íš¨) ìƒì„± =====
    // lines[0] = 1íš¨(ë§¨ ì•„ë˜), lines[5] = 6íš¨(ë§¨ ìœ„)
    function deriveLines(bytes){
      const lines = [];
      const moving = [];
      for (let i=0;i<6;i++){
        const b = bytes[i];
        const isYang = (b & 1) === 1;          // ìŒ/ì–‘
        const isMoving = ((b >> 1) & 1) === 1; // ë³€íš¨ ì—¬ë¶€
        lines.push(isYang ? 1 : 0);
        moving.push(isMoving);
      }
      // ë³€ê´˜(ì§€ê´˜): ë³€íš¨ì¸ ìë¦¬ë§Œ ë°˜ì „
      const changed = lines.map((v, idx) => moving[idx] ? (v ? 0 : 1) : v);
      return { lines, moving, changed };
    }

    function trigramFromLines(bottom3){
      // bottom3 is [line1,line2,line3] each 0/1
      const key = `${bottom3[0]}${bottom3[1]}${bottom3[2]}`;
      return TRIGRAMS[key] || null;
    }

    function dominantElement(upper, lower, moving){
      // ë‹¨ìˆœ ê·œì¹™: ë³€íš¨ê°€ ìƒê´˜(4~6íš¨)ì— ë” ë§ìœ¼ë©´ ìƒê´˜ ì˜¤í–‰, ì•„ë‹ˆë©´ í•˜ê´˜ ì˜¤í–‰
      const upperMoving = (moving[3]?1:0)+(moving[4]?1:0)+(moving[5]?1:0);
      const lowerMoving = (moving[0]?1:0)+(moving[1]?1:0)+(moving[2]?1:0);
      if (upper.element === lower.element) return upper.element;
      return (upperMoving >= lowerMoving) ? upper.element : lower.element;
    }

    // ===== ë¡œë˜ ë²ˆí˜¸ ìƒì„±(1~45, ì¤‘ë³µ ì œê±°) =====
    function pickUniqueNumbers(bytes, count, offset){
      const out = [];
      let p = offset;
      // ì¶©ë¶„íˆ ë½‘ì„ ë•Œê¹Œì§€(ìµœì•…ì˜ ê²½ìš° ëŒ€ë¹„í•´ ì•ˆì „ì¥ì¹˜)
      let guard = 0;
      while (out.length < count && guard < 4000){
        const hi = bytes[p % bytes.length];
        const lo = bytes[(p+1) % bytes.length];
        p += 2;
        const v = ((hi << 8) | lo) % 45 + 1;
        if (!out.includes(v)) out.push(v);
        guard++;
      }
      out.sort((a,b)=>a-b);
      return out;
    }

    // ===== UI ë Œë” =====
    function renderHex(targetEl, lines, moving){
      // í‘œì‹œ: 6íš¨(ìœ„ì—ì„œ ì•„ë˜ë¡œ ë³´ì—¬ì£¼ë˜, ë¼ë²¨ì€ 6íš¨->1íš¨)
      targetEl.innerHTML = "";
      for (let visualIdx = 5; visualIdx >= 0; visualIdx--){
        const eff = visualIdx + 1; // íš¨ ë²ˆí˜¸
        const isYang = lines[visualIdx] === 1;
        const isMoving = moving ? !!moving[visualIdx] : false;

        const row = document.createElement("div");
        row.className = "lineRow";

        const lbl = document.createElement("div");
        lbl.className = "lineLabel";
        lbl.textContent = `${eff}íš¨`;

        const bar = document.createElement("div");
        bar.className = "lineBar " + (isYang ? "yang" : "yin");

        if (isYang){
          const seg = document.createElement("div");
          seg.className = "seg";
          bar.appendChild(seg);
        } else {
          const seg1 = document.createElement("div");
          seg1.className = "seg";
          const seg2 = document.createElement("div");
          seg2.className = "seg";
          bar.appendChild(seg1);
          bar.appendChild(seg2);
        }

        const tag = document.createElement("div");
        tag.className = "movingTag";
        tag.textContent = isMoving ? "ë³€íš¨" : "ê³ ì •";
        tag.style.visibility = isMoving ? "visible" : "hidden";

        row.appendChild(lbl);
        row.appendChild(bar);
        row.appendChild(tag);
        targetEl.appendChild(row);
      }
    }

    function getBallRange(n){
      if (n >= 1 && n <= 10) return "1";
      if (n >= 11 && n <= 20) return "2";
      if (n >= 21 && n <= 30) return "3";
      if (n >= 31 && n <= 40) return "4";
      return "5";
    }

    function setBall(container, nums, cls){
      container.innerHTML = "";
      nums.forEach((n, idx)=>{
        const d = document.createElement("div");
        d.className = "ball " + (cls || "");
        d.setAttribute("data-range", getBallRange(n));
        d.style.animationDelay = (idx * 50) + "ms";
        d.textContent = n;
        container.appendChild(d);
      });
    }

    function buildReasons(mainNums, ctx){
      const { upper, lower, domEl, moving, lines } = ctx;
      const moveIdx = moving.map((m,i)=>m ? (i+1) : null).filter(Boolean); // 1~6íš¨
      const moveText = moveIdx.length ? `${moveIdx.join(",")}íš¨` : "ì—†ìŒ";

      return mainNums.map((n, i) => {
        const el = numberElement(n);
        const linePos = (n % 6) === 0 ? 6 : (n % 6); // 1~6
        const isMoving = !!moving[linePos-1];
        const yinYang = lines[linePos-1] === 1 ? "ì–‘(â€”)" : "ìŒ(â€“ â€“)";

        // ìƒìƒ/ìƒê·¹ ê´€ê³„ë¥¼ ìŠ¤í† ë¦¬ë¡œ ë³€í™˜
        const gen = GENERATES[domEl];
        const over = OVERCOMES[domEl];

        let story = "";
        if (el === domEl) {
          story = `ğŸ¯ ë‹¹ì‹ ì˜ í•µì‹¬ ì—ë„ˆì§€ (${domEl}) â€” ê°€ì¥ ê°•ë ¥í•˜ê²Œ ê³µëª…í•˜ëŠ” ìˆ«ìì…ë‹ˆë‹¤. ì´ ìˆ«ìëŠ” ë‹¹ì‹ ì˜ ë³¸ì§ˆì ì¸ ì„±ì§ˆê³¼ ê°€ì¥ ê¹Šì´ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
        } else if (el === gen) {
          story = `ğŸŒ± íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€ (${domEl}â†’${gen}) â€” ë‹¹ì‹ ì˜ ì¤‘ì‹¬ ì—ë„ˆì§€ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë°œì „í•˜ê³  ì»¤ì§€ëŠ” ë°©í–¥ì…ë‹ˆë‹¤. ì´ ìˆ«ìì™€ í•¨ê»˜í•˜ë©´ ì¢‹ì€ ì¼ë“¤ì´ ì°¨ë¡€ì°¨ë¡€ í¼ì³ì§‘ë‹ˆë‹¤.`;
        } else if (el === over) {
          story = `âš–ï¸ ê· í˜•ê³¼ ì¡°í™” (${domEl}âŠ£${over}) â€” ë‹¹ì‹ ì˜ ì—ë„ˆì§€ë¥¼ ê²¬ì œí•˜ëŠ” í˜ì…ë‹ˆë‹¤. ë‚˜ìœ ê²ƒë§Œì€ ì•„ë‹™ë‹ˆë‹¤. ì´ ìˆ«ìëŠ” ë‹¹ì‹ ì„ ì¤‘ì‹¬ì— ë¨¸ë¬¼ê²Œ í•˜ê³  ì•ˆì •ì‹œí‚µë‹ˆë‹¤.`;
        } else {
          story = `ğŸŒ€ ìš°ì£¼ì˜ ë°°ì¹˜ â€” ë‹¹ì‹ ì˜ í•µì‹¬ ì—ë„ˆì§€ì™€ëŠ” ë‹¤ë¥¸ ë°©í–¥ì˜ ìˆ«ìì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ê´€ì ì„ ì œì‹œí•˜ê³ , ì˜ˆìƒì¹˜ ëª»í•œ ê¸°íšŒë¥¼ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤.`;
        }

        const moveNote = isMoving
          ? `[ âš¡ ë³€í™”ì˜ í¬ì¸íŠ¸ ] ${linePos}íš¨ê°€ ë³€í•˜ê³  ìˆìŠµë‹ˆë‹¤ â†’ ì´ ìˆ«ì ì˜ì—­ì—ì„œ ë‹¹ì‹ ì˜ ì—ë„ˆì§€ê°€ í˜„ì¬ ë³€ì„± ì¤‘ì…ë‹ˆë‹¤.`
          : `[ ğŸŒ¿ ì•ˆì •ì˜ ìë¦¬ ] ${linePos}íš¨ëŠ” ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤ â†’ ì´ ì—ë„ˆì§€ëŠ” ë‹¹ì‹ ì˜ í™•ê³ í•œ ê¸°ì´ˆë¥¼ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤.`;

        return `${i+1}ë²ˆ: <strong>${n}</strong> (${el})\n${story}\n${moveNote}`;
      });
    }

    async function generate(){
      const year = document.getElementById("birthYear").value;
      const month = document.getElementById("birthMonth").value;
      const day = document.getElementById("birthDay").value;
      const hour = document.getElementById("birthHour").value;
      const minute = document.getElementById("birthMinute").value;

      const errEl = document.getElementById("err");
      const msgEl = document.getElementById("msg");

      errEl.textContent = "";
      msgEl.textContent = "";

      if (!year || !month || !day){
        errEl.textContent = "ìƒë…„ì›”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.";
        return;
      }

      const birthDate = `${year}-${month}-${day}`;
      const birthTime = (hour && minute) ? `${hour}:${minute}` : "";
      
      const seed = birthTime ? `${birthDate}T${birthTime}` : `${birthDate}`;
      msgEl.textContent = `ì”¨ë“œ: ${seed} (ê²°ì •ë¡ ì  ìƒì„±)`;

      // URL ë°˜ì˜ (ê³µìœ /ì¬í˜„)
      const usp = new URLSearchParams(location.search);
      usp.set("d", birthDate);
      if (birthTime) usp.set("t", birthTime); else usp.delete("t");
      history.replaceState({}, "", `${location.pathname}?${usp.toString()}`);

      const bytes = await sha256Bytes(seed);
      const { lines, moving, changed } = deriveLines(bytes);

      const lower = trigramFromLines([lines[0], lines[1], lines[2]]);
      const upper = trigramFromLines([lines[3], lines[4], lines[5]]);
      const domEl = dominantElement(upper, lower, moving);

      // 5ì„¸íŠ¸ ëœë¤ ìƒì„±
      const allSets = [];
      for (let setIdx = 0; setIdx < 5; setIdx++) {
        const nums = [];
        while (nums.length < 5) {
          const n = Math.floor(Math.random() * 45) + 1; // 1~45 ëœë¤
          if (!nums.includes(n)) nums.push(n);
        }
        nums.sort((a, b) => a - b);
        allSets.push(nums);
      }

      // UI í‘œì‹œ
      document.getElementById("resultEmpty").style.display = "none";
      document.getElementById("result").style.display = "block";

      document.getElementById("pillSeed").textContent = `ì…ë ¥: ${seed}`;
      document.getElementById("pillUpper").textContent = `ìƒê´˜: ${upper.symbol} ${upper.name} Â· ${upper.nature} Â· ${upper.element}`;
      document.getElementById("pillLower").textContent = `í•˜ê´˜: ${lower.symbol} ${lower.name} Â· ${lower.nature} Â· ${lower.element}`;
      document.getElementById("pillDominant").textContent = `ì¤‘ì‹¬ ì˜¤í–‰(ê·œì¹™): ${domEl}`;

      // 5ì„¸íŠ¸ í‘œì‹œ
      const setsContainer = document.getElementById("allLottoSets");
      setsContainer.innerHTML = "";
      allSets.forEach((nums, idx) => {
        const setDiv = document.createElement("div");
        setDiv.style.cssText = "padding: 12px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.2);";
        
        const textDiv = document.createElement("div");
        textDiv.style.cssText = "font-weight: 700; font-size: 18px; color: #1f2937; margin-bottom: 10px;";
        textDiv.textContent = `${idx + 1}ë²ˆ: ${nums.join(" - ")}`;
        setDiv.appendChild(textDiv);
        
        const ballsDiv = document.createElement("div");
        ballsDiv.className = "nums";
        setBall(ballsDiv, nums, "");
        setDiv.appendChild(ballsDiv);
        
        setsContainer.appendChild(setDiv);
      });

      renderHex(document.getElementById("hexOriginal"), lines, moving);
      // ì§€ê´˜ëŠ” "ë³€íš¨" ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë©´ í˜¼ë™ë˜ë‹ˆ, ë¼ë²¨ë§Œ ê³ ì • í‘œì‹œ
      renderHex(document.getElementById("hexChanged"), changed, moving);

      const mainNums = allSets[0]; // ì²« ë²ˆì§¸ ì„¸íŠ¸ë¡œ ì„¤ëª… í‘œì‹œ
      const reasons = buildReasons(mainNums, { upper, lower, domEl, moving, lines });
      const ul = document.getElementById("reasons");
      ul.innerHTML = "";
      reasons.forEach(r=>{
        const li = document.createElement("li");
        // HTML í¬ë§·íŒ…: ì¤„ ë°”ê¿ˆê³¼ ê°•ì¡° ì²˜ë¦¬
        li.innerHTML = r.replace(/\n/g, "<br>").replace(/\[ ([^\]]+) \]/g, "<strong style='color: #6366f1;'>[ $1 ]</strong>");
        ul.appendChild(li);
      });
    }

    // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function initializeDateSelects(){
      const yearSelect = document.getElementById("birthYear");
      const monthSelect = document.getElementById("birthMonth");
      const daySelect = document.getElementById("birthDay");
      const hourSelect = document.getElementById("birthHour");
      const minuteSelect = document.getElementById("birthMinute");

      // ë…„ë„: 1900~2050
      for (let y = 2050; y >= 1900; y--){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      // ì›”: 1~12 (íŒ¨ë”©: 01~12)
      for (let m = 1; m <= 12; m++){
        const opt = document.createElement("option");
        opt.value = String(m).padStart(2, "0");
        opt.textContent = `${m}ì›”`;
        monthSelect.appendChild(opt);
      }

      // ì¼: 1~31 (íŒ¨ë”©: 01~31)
      for (let d = 1; d <= 31; d++){
        const opt = document.createElement("option");
        opt.value = String(d).padStart(2, "0");
        opt.textContent = `${d}ì¼`;
        daySelect.appendChild(opt);
      }

      // ì‹œê°„: 0~23 (íŒ¨ë”©: 00~23)
      for (let h = 0; h < 24; h++){
        const opt = document.createElement("option");
        opt.value = String(h).padStart(2, "0");
        opt.textContent = `${h.toString().padStart(2,"0")}ì‹œ`;
        hourSelect.appendChild(opt);
      }

      // ë¶„: 0, 30ë¶„ ë‹¨ìœ„ (íŒ¨ë”©: 00, 30)
      for (let m = 0; m < 60; m += 30){
        const opt = document.createElement("option");
        opt.value = String(m).padStart(2, "0");
        opt.textContent = `${m.toString().padStart(2,"0")}ë¶„`;
        minuteSelect.appendChild(opt);
      }
    }

    // yyyymmdd ë¹ ë¥¸ ì…ë ¥ ì²˜ë¦¬
    function handleQuickDateInput(e){
      const input = e.target.value;
      const digitsOnly = input.replace(/[^0-9]/g, "");
      
      // í‘œì‹œìš© í¬ë§¤íŒ…
      let display = "";
      if (digitsOnly.length > 0 && digitsOnly.length <= 4) {
        display = digitsOnly;
      } else if (digitsOnly.length > 4 && digitsOnly.length <= 6) {
        display = digitsOnly.substring(0, 4) + "-" + digitsOnly.substring(4);
      } else if (digitsOnly.length > 6) {
        display = digitsOnly.substring(0, 4) + "-" + digitsOnly.substring(4, 6) + "-" + digitsOnly.substring(6, 8);
      }
      e.target.value = display;
      
      // ì •í™•íˆ 8ìë¦¬ì¼ ë•Œë§Œ ì²˜ë¦¬
      if (digitsOnly.length === 8) {
        const year = digitsOnly.substring(0, 4);
        const month = digitsOnly.substring(4, 6);
        const day = digitsOnly.substring(6, 8);
        
        const y = parseInt(year, 10);
        const m = parseInt(month, 10);
        const d = parseInt(day, 10);
        
        // ìœ íš¨ì„± ê²€ì¦
        if (y >= 1900 && y <= 2050 && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          // ë“œë¡­ë‹¤ìš´ ì„¤ì • (ê°’ì´ íŒ¨ë”©ëœ ë¬¸ìì—´ì´ë¯€ë¡œ íŒ¨ë”© ìƒíƒœë¡œ ì„¤ì •)
          document.getElementById("birthYear").value = year;
          document.getElementById("birthMonth").value = month;
          document.getElementById("birthDay").value = day;
          
          // 3ì´ˆ í›„ ì…ë ¥ì°½ ì´ˆê¸°í™”
          setTimeout(() => {
            e.target.value = "";
          }, 3000);
        } else {
          // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ
          e.target.style.borderColor = "#ef4444";
          e.target.style.background = "#fef2f2";
          setTimeout(() => {
            e.target.style.borderColor = "#e5e7eb";
            e.target.style.background = "#f9fafb";
          }, 2000);
        }
      }
    }

    // ì´ˆê¸°ê°’(ì¿¼ë¦¬ì—ì„œ ë³µì›)
    function hydrateFromQuery(){
      const usp = new URLSearchParams(location.search);
      const d = usp.get("d");
      const t = usp.get("t");
      if (d){
        const parts = d.split("-");
        if (parts.length === 3){
          document.getElementById("birthYear").value = parts[0];
          document.getElementById("birthMonth").value = parts[1];
          document.getElementById("birthDay").value = parts[2];
        }
      }
      if (t){
        const parts = t.split(":");
        if (parts.length === 2){
          document.getElementById("birthHour").value = parts[0];
          document.getElementById("birthMinute").value = parts[1];
        }
      }
      if (d) generate();
    }

    // ì´ˆê¸°í™”
    initializeDateSelects();
    document.getElementById("btn").addEventListener("click", generate);
    document.getElementById("quickDateInput").addEventListener("input", handleQuickDateInput);
    hydrateFromQuery();
  </script>
</body>
</html>